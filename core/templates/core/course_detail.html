{% extends 'core/base.html' %}
{% load static %}

{% block title %}{{ course.title }} - Khóa Học{% endblock %}

{% block content %}
{% csrf_token %}
<div class="min-h-screen bg-white">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 mt-16">
            <a href="{% url 'core:courses' %}"
                  class="inline-flex items-center text-gray-600 hover:text-black transition-colors mb-6">
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                  </svg>
                  Quay lại danh sách khóa học
            </a>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                  <!-- Main Content -->
                  <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white rounded-xl shadow-md overflow-hidden"
                              style="box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05);">
                              <div class="relative h-[400px] w-full">
                                    {% if course.image %}
                                        <img src="{{ course.image.url }}" alt="{{ course.title }}"
                                              class="w-full h-full object-cover">
                                    {% else %}
                                        <div class="w-full h-full bg-gray-200 flex items-center justify-center">
                                            <div class="text-center text-gray-500">
                                                <svg class="w-16 h-16 mx-auto mb-2" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" />
                                                </svg>
                                                <p>Không có ảnh</p>
                                            </div>
                                        </div>
                                    {% endif %}
                              </div>
                              <div class="p-6">
                                    <h1
                                          class="text-3xl font-bold mb-4 bg-clip-text text-transparent bg-gradient-to-r from-gray-800 to-black">
                                          {{ course.title }}
                                    </h1>
                                    <p class="text-gray-600">{{ course.description }}</p>
                              </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-md p-6"
                              style="box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05);">
                              <h2 class="text-2xl font-semibold mb-6 text-gray-900">
                                    Nội dung khóa học
                              </h2>
                              <div class="space-y-4">
                                    {% for item in course.curriculum_items.all %}
                                    <div
                                          class="flex items-start p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                                          <span
                                                class="flex items-center justify-center w-8 h-8 bg-black text-white rounded-full mr-4 font-semibold">
                                                {{ forloop.counter }}
                                          </span>
                                          <div>
                                                <p class="text-gray-800 font-medium">{{ item.title }}</p>
                                          </div>
                                    </div>
                                    {% endfor %}
                              </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-md p-6"
                              style="box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05);">
                              <h2 class="text-2xl font-semibold mb-6 text-gray-900">
                                    Bạn sẽ nhận được gì?
                              </h2>
                              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    {% for feature in course.features.all %}
                                    <div
                                          class="flex items-start p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                                          <svg class="w-6 h-6 text-green-500 mr-3 flex-shrink-0" fill="none"
                                                stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                      d="M5 13l4 4L19 7" />
                                          </svg>
                                          <p class="text-gray-700">{{ feature.title }}</p>
                                    </div>
                                    {% endfor %}
                              </div>
                        </div>
                  </div>

                  <!-- Sidebar -->
                  <div class="lg:col-span-1">
                        <div class="sticky top-8 space-y-6">
                              <div class="bg-white rounded-xl shadow-md p-6"
                                    style="box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05);">
                                    <div class="space-y-4">
                                          <div class="flex items-center justify-between">
                                                <span class="text-gray-600">Giá khóa học</span>
                                                <span class="text-2xl font-bold text-black">{{ course.get_price_display }}
                                                      VND</span>
                                          </div>
                                          <button onclick="openEnrollmentModal()"
                                                class="w-full bg-black text-white px-6 py-3 rounded-md hover:bg-gray-800 transition-all font-semibold"
                                                style="box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                                                Đăng ký ngay
                                          </button>
                                          <p class="text-sm text-gray-500 text-center">* Bảo đảm hoàn tiền trong 30 ngày
                                          </p>
                                    </div>
                              </div>

                              <div class="bg-white rounded-xl shadow-md p-6"
                                    style="box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05);">
                                    <h3 class="text-lg font-semibold mb-4 text-gray-900">
                                          Thông tin khóa học
                                    </h3>
                                    <div class="space-y-4">
                                          <div class="flex items-center text-gray-600">
                                                <svg class="w-5 h-5 mr-3 text-gray-500" fill="none"
                                                      stroke="currentColor" viewBox="0 0 24 24">
                                                      <path stroke-linecap="round" stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                                </svg>
                                                <div>
                                                      <p class="text-sm text-gray-500">Giảng viên</p>
                                                      <p class="font-medium">{{ course.instructor.name }}</p>
                                                </div>
                                          </div>
                                          <div class="flex items-center text-gray-600">
                                                <svg class="w-5 h-5 mr-3 text-gray-500" fill="none"
                                                      stroke="currentColor" viewBox="0 0 24 24">
                                                      <path stroke-linecap="round" stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                                <div>
                                                      <p class="text-sm text-gray-500">Thời lượng</p>
                                                      <p class="font-medium">{{ course.duration }}</p>
                                                </div>
                                          </div>
                                          <div class="flex items-center text-gray-600">
                                                <svg class="w-5 h-5 mr-3 text-gray-500" fill="none"
                                                      stroke="currentColor" viewBox="0 0 24 24">
                                                      <path stroke-linecap="round" stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                                </svg>
                                                <div>
                                                      <p class="text-sm text-gray-500">Học viên đăng ký</p>
                                                      <p class="font-medium">{{ course.students_count|floatformat:0 }}</p>
                                                </div>
                                          </div>
                                    </div>
                              </div>
                        </div>
                  </div>
            </div>
      </div>
</div>

<!-- Course Enrollment Modal -->
<div id="enrollmentModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
      <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full relative"
                  style="box-shadow: 0 25px 50px rgba(0,0,0,0.25);">
                  <!-- Close Button -->
                  <button onclick="closeEnrollmentModal()"
                        class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12" />
                        </svg>
                  </button>

                  <!-- Step 1: Information Form -->
                  <div id="step1" class="p-8">
                        <div class="text-center mb-6">
                              <h3 class="text-2xl font-bold text-gray-900 mb-2">Đăng ký khóa học</h3>
                              <p class="text-gray-600">{{ course.title }}</p>
                              <div class="flex justify-center mt-4">
                                    <div class="flex space-x-2">
                                          <div class="w-8 h-2 bg-black rounded-full"></div>
                                          <div class="w-8 h-2 bg-gray-200 rounded-full"></div>
                                          <div class="w-8 h-2 bg-gray-200 rounded-full"></div>
                                          <div class="w-8 h-2 bg-gray-200 rounded-full"></div>
                                    </div>
                              </div>
                        </div>

                        <form id="enrollmentForm">
                              <div class="space-y-4">
                                    <div>
                                          <label for="fullname" class="block text-sm font-medium text-gray-700 mb-2">Họ
                                                và tên</label>
                                          <input type="text" id="fullname" name="fullname" required
                                                class="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-black focus:border-black transition-colors"
                                                placeholder="Nhập họ và tên của bạn">
                                    </div>
                                    <div>
                                          <label for="email"
                                                class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                          <input type="email" id="email" name="email" required
                                                class="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-black focus:border-black transition-colors"
                                                placeholder="Nhập email của bạn">
                                    </div>
                                    <div>
                                          <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">Số
                                                điện thoại</label>
                                          <input type="tel" id="phone" name="phone" required
                                                class="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-black focus:border-black transition-colors"
                                                placeholder="Nhập số điện thoại của bạn">
                                    </div>
                              </div>

                              <button type="button" onclick="goToStep2()"
                                    class="w-full mt-6 bg-black text-white py-3 rounded-md hover:bg-gray-800 transition-all font-semibold"
                                    style="box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                                    Xác nhận
                              </button>
                        </form>
                  </div>

                  <!-- Step 2: Confirmation -->
                  <div id="step2" class="p-8 hidden">
                        <div class="text-center mb-6">
                              <h3 class="text-2xl font-bold text-gray-900 mb-2">Xác nhận thông tin</h3>
                              <p class="text-gray-600">Kiểm tra lại thông tin đăng ký</p>
                              <div class="flex justify-center mt-4">
                                    <div class="flex space-x-2">
                                          <div class="w-8 h-2 bg-black rounded-full"></div>
                                          <div class="w-8 h-2 bg-black rounded-full"></div>
                                          <div class="w-8 h-2 bg-gray-200 rounded-full"></div>
                                          <div class="w-8 h-2 bg-gray-200 rounded-full"></div>
                                    </div>
                              </div>
                        </div>

                        <div class="space-y-4 mb-6">
                              <div class="bg-gray-50 p-4 rounded-lg">
                                    <h4 class="font-semibold text-gray-900 mb-2">{{ course.title }}</h4>
                                    <p class="text-gray-600">Giá: <span class="font-semibold">{{ course.price }}
                                                VND</span></p>
                              </div>

                              <div class="bg-gray-50 p-4 rounded-lg">
                                    <h4 class="font-semibold text-gray-900 mb-2">Thông tin học viên</h4>
                                    <p class="text-gray-600">Họ tên: <span id="confirmFullname"
                                                class="font-semibold"></span></p>
                                    <p class="text-gray-600">Email: <span id="confirmEmail"
                                                class="font-semibold"></span></p>
                                    <p class="text-gray-600">Điện thoại: <span id="confirmPhone"
                                                class="font-semibold"></span></p>
                              </div>
                        </div>

                        <div class="flex space-x-3">
                              <button type="button" onclick="goToStep1()"
                                    class="flex-1 border border-gray-300 text-gray-700 py-3 rounded-md hover:bg-gray-50 transition-all font-semibold">
                                    Quay lại
                              </button>
                              <button type="button" onclick="submitEnrollment()"
                                    class="flex-1 bg-black text-white py-3 rounded-md hover:bg-gray-800 transition-all font-semibold"
                                    style="box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                                    Tiếp tục thanh toán
                              </button>
                        </div>
                  </div>

                  <!-- Step 3: QR Code Payment -->
                  <div id="step3" class="p-8 hidden text-center">
                        <div class="mb-6">
                              <div class="flex justify-center mt-4">
                                    <div class="flex space-x-2">
                                          <div class="w-8 h-2 bg-black rounded-full"></div>
                                          <div class="w-8 h-2 bg-black rounded-full"></div>
                                          <div class="w-8 h-2 bg-black rounded-full"></div>
                                          <div class="w-8 h-2 bg-gray-200 rounded-full"></div>
                                    </div>
                              </div>
                              <h3 class="text-xl font-bold text-gray-900 mt-6 mb-2">Thanh toán khóa học</h3>
                              <p class="text-gray-600">Quét mã QR để thanh toán</p>
                        </div>

                        <div class="bg-gray-50 p-6 rounded-lg mb-6">
                              <div class="flex justify-center mb-4">
                                    <img src="{% static 'core/images/qrcode/qrcode.svg' %}" alt="QR Code"
                                          class="w-48 h-48 border border-gray-200 rounded-lg">
                              </div>
                              <div class="text-center">
                                    <p class="text-lg font-semibold text-gray-900 mb-1">{{ course.title }}</p>
                                    <p class="text-xl font-bold text-black">{{ course.price }} VND</p>
                                    <p class="text-sm text-gray-600 mt-2">Quét mã QR bằng ứng dụng ngân hàng để thanh
                                          toán</p>
                              </div>
                        </div>

                        <div class="space-y-3">
                              <button type="button" onclick="confirmPayment()"
                                    class="w-full bg-green-600 text-white py-3 rounded-md hover:bg-green-700 transition-all font-semibold"
                                    style="box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                                    Xác nhận đã thanh toán
                              </button>
                              <button type="button" onclick="goToStep2()"
                                    class="w-full border border-gray-300 text-gray-700 py-3 rounded-md hover:bg-gray-50 transition-all font-semibold">
                                    Quay lại
                              </button>
                        </div>
                  </div>

                  <!-- Step 4: Success -->
                  <div id="step4" class="p-8 hidden text-center">
                        <div class="mb-6">
                              <div class="flex justify-center mt-4">
                                    <div class="flex space-x-2">
                                          <div class="w-8 h-2 bg-black rounded-full"></div>
                                          <div class="w-8 h-2 bg-black rounded-full"></div>
                                          <div class="w-8 h-2 bg-black rounded-full"></div>
                                          <div class="w-8 h-2 bg-black rounded-full"></div>
                                    </div>
                              </div>
                              <div
                                    class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mt-6">
                                    <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor"
                                          viewBox="0 0 24 24">
                                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M5 13l4 4L19 7" />
                                    </svg>
                              </div>
                              <h3 class="text-xl font-bold text-gray-900 mt-4">Đăng ký thành công!</h3>
                              <p class="text-gray-600">Chúng tôi sẽ liên hệ với bạn để xác nhận thanh toán</p>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-lg mb-6">
                              <h4 class="font-semibold text-gray-900 mb-2">Thông tin thanh toán</h4>
                              <p class="text-gray-600 text-sm">Trạng thái: <span class="text-green-600 font-semibold">Đã
                                          xác nhận thanh toán</span></p>
                              <p class="text-gray-600 text-sm mt-2">
                                    Cảm ơn bạn đã đăng ký khóa học. Chúng tôi sẽ liên hệ với bạn để cung cấp thông tin
                                    chi tiết về khóa học trong thời gian sớm nhất. Nếu có vấn đề gì, vui lòng liên hệ
                                    với chúng tôi qua số điện thoại
                                    0123456789.
                              </p>
                        </div>

                        <button type="button" onclick="closeEnrollmentModal()"
                              class="w-full bg-black text-white py-3 rounded-md hover:bg-gray-800 transition-all font-semibold"
                              style="box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                              Đóng
                        </button>
                  </div>
            </div>
      </div>
</div>

<script>
      // Course enrollment modal functionality
      function openEnrollmentModal() {
            document.getElementById('enrollmentModal').classList.remove('hidden');
            goToStep1();
      }

      function closeEnrollmentModal() {
            document.getElementById('enrollmentModal').classList.add('hidden');
            // Reset form
            document.getElementById('enrollmentForm').reset();
      }

      function goToStep1() {
            hideAllSteps();
            document.getElementById('step1').classList.remove('hidden');
      }

      function goToStep2() {
            // Validate form
            const fullname = document.getElementById('fullname').value;
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;

            if (!fullname || !email || !phone) {
                  alert('Vui lòng điền đầy đủ thông tin');
                  return;
            }

            // Validate email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                  alert('Vui lòng nhập email hợp lệ');
                  return;
            }

            // Update confirmation info
            document.getElementById('confirmFullname').textContent = fullname;
            document.getElementById('confirmEmail').textContent = email;
            document.getElementById('confirmPhone').textContent = phone;

            hideAllSteps();
            document.getElementById('step2').classList.remove('hidden');
      }

      function hideAllSteps() {
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.add('hidden');
            document.getElementById('step4').classList.add('hidden');
      }

      function submitEnrollment() {
            hideAllSteps();
            document.getElementById('step3').classList.remove('hidden');
      }

      function confirmPayment() {
            // Show processing step temporarily
            hideAllSteps();

            // Create a temporary processing step
            const step3 = document.getElementById('step3');
            const originalContent = step3.innerHTML;

            step3.innerHTML = `
        <div class="p-8 text-center">
            <div class="mb-6">
                <div class="flex justify-center mt-4">
                    <div class="flex space-x-2">
                        <div class="w-8 h-2 bg-black rounded-full"></div>
                        <div class="w-8 h-2 bg-black rounded-full"></div>
                        <div class="w-8 h-2 bg-black rounded-full"></div>
                        <div class="w-8 h-2 bg-black rounded-full"></div>
                    </div>
                </div>
                <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-black mx-auto mt-6"></div>
                <h3 class="text-xl font-bold text-gray-900 mt-4">Đang xử lý đăng ký...</h3>
                <p class="text-gray-600">Vui lòng chờ trong giây lát</p>
            </div>
        </div>
    `;

            step3.classList.remove('hidden');

            // Get form data
            const formData = {
                  course_slug: '{{ course.slug }}',
                  course_title: '{{ course.title }}',
                  course_price: '{{ course.price }}',
                  fullname: document.getElementById('fullname').value,
                  email: document.getElementById('email').value,
                  phone: document.getElementById('phone').value,
            };

            // Submit enrollment
            fetch('{% url "core:create_course_enrollment" %}', {
                  method: 'POST',
                  headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value || '{{ csrf_token }}'
                  },
                  body: JSON.stringify(formData)
            })
                  .then(response => response.json())
                  .then(data => {
                        if (data.success) {
                              setTimeout(() => {
                                    // Restore original content and show step 4
                                    step3.innerHTML = originalContent;
                                    hideAllSteps();
                                    document.getElementById('step4').classList.remove('hidden');
                              }, 2000);
                        } else {
                              // Restore original content and show error
                              step3.innerHTML = originalContent;
                              alert('Có lỗi xảy ra: ' + data.error);
                              hideAllSteps();
                              document.getElementById('step3').classList.remove('hidden');
                        }
                  })
                  .catch(error => {
                        console.error('Error:', error);
                        // Restore original content and show error
                        step3.innerHTML = originalContent;
                        alert('Có lỗi xảy ra khi đăng ký. Vui lòng thử lại.');
                        hideAllSteps();
                        document.getElementById('step3').classList.remove('hidden');
                  });
      }

      // Close modal when clicking outside
      document.getElementById('enrollmentModal').addEventListener('click', function (e) {
            if (e.target === this) {
                  closeEnrollmentModal();
            }
      });
</script>
{% endblock %}