{% extends 'core/base.html' %}
{% load static %}

{% block title %}{{ listing.title }} - Airbnb{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 mt-16">
    <!-- Header -->
    <a href="{% url 'core:airbnb' %}"
        class="inline-flex items-center text-gray-600 hover:text-black transition-colors mb-6">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Quay lại danh sách Airbnb
    </a>
    <h1 class="text-3xl font-bold mb-4 bg-clip-text text-transparent bg-gradient-to-r from-gray-800 to-black">
        {{ listing.title }}
    </h1>
    <p class="text-gray-600 mb-6">{{ listing.location.name_vietnamese }}</p>

    <!-- Image Gallery -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
        <div class="relative h-96 overflow-hidden rounded-xl"
            style="box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05);">
            {% if listing.images.exists %}
            <img src="{{ listing.images.first.image.url }}" alt="{{ listing.title }}"
                class="w-full h-full object-cover">
            {% else %}
            <div class="w-full h-full bg-gray-200 flex items-center justify-center">
                <i data-lucide="image" class="w-16 h-16 text-gray-400"></i>
            </div>
            {% endif %}
        </div>
        <div class="grid grid-cols-2 gap-4">
            {% for image in listing.images.all|slice:"1:4" %}
            <div class="relative h-44 overflow-hidden rounded-xl"
                style="box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05);">
                <img src="{{ image.image.url }}" alt="{{ listing.title }} {{ forloop.counter|add:1 }}"
                    class="w-full h-full object-cover">
            </div>
            {% empty %}
            {% for i in "123" %}
            <div class="relative h-44 overflow-hidden rounded-xl bg-gray-200 flex items-center justify-center"
                style="box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05);">
                <i data-lucide="image" class="w-8 h-8 text-gray-400"></i>
            </div>
            {% endfor %}
            {% endfor %}
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <!-- Main Content -->
        <div class="md:col-span-2">
            <div class="mb-8">
                <h2 class="text-2xl font-semibold mb-4 text-gray-900">About this place</h2>
                <p class="text-gray-600">{{ listing.description }}</p>
            </div>

            <div class="mb-8">
                <h2 class="text-2xl font-semibold mb-4 text-gray-900">What this place offers</h2>
                <div class="grid grid-cols-2 gap-4">
                    {% for listing_amenity in listing.amenities.all %}
                    <div class="flex items-center p-2 hover:bg-gray-50 rounded-lg transition-colors">
                        <span class="text-black font-bold">✓</span>
                        <span class="ml-2">{{ listing_amenity.amenity.name }}</span>
                    </div>
                    {% empty %}
                    <div class="col-span-2">
                        <p class="text-gray-500 italic">Thông tin tiện nghi sẽ được cập nhật</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="mb-8">
                <h2 class="text-2xl font-semibold mb-4 text-gray-900">Host</h2>
                <div class="flex items-center">
                    <div class="relative h-16 w-16 rounded-full overflow-hidden border-2 border-white"
                        style="box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                        {% if listing.host_image %}
                        <img src="{{ listing.host_image.url }}" alt="{{ listing.host_name }}"
                            class="w-full h-full object-cover">
                        {% else %}
                        <div class="w-full h-full bg-gray-200 flex items-center justify-center">
                            <i data-lucide="user" class="w-8 h-8 text-gray-400"></i>
                        </div>
                        {% endif %}
                    </div>
                    <div class="ml-4">
                        <h3 class="font-semibold">{{ listing.host_name|default:"Viet Anh" }}</h3>
                        <p class="text-gray-600">Response time: within an hour</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Booking Card -->
        <div class="md:col-span-1">
            <div class="bg-white rounded-xl shadow-md p-6 sticky top-8"
                style="box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05);">
                <div class="mb-6">
                    <span class="text-2xl font-bold">{{ listing.price|floatformat:"0" }} VND</span>
                    <span class="text-gray-600">/night</span>
                </div>

                <div class="space-y-4">
                    <button onclick="openBookingModal()"
                        class="w-full bg-black text-white py-3 rounded-md hover:bg-gray-800 transition-all font-semibold"
                        style="box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                        Đặt phòng trực tiếp
                    </button>

                    {% if listing.airbnb_link %}
                    <a href="{{ listing.airbnb_link }}" target="_blank" rel="noopener noreferrer"
                        class="block w-full bg-[#FF5A5F] text-white text-center py-3 rounded-md hover:bg-[#FF385F] transition-all"
                        style="box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                        Book on Airbnb
                    </a>
                    {% endif %}

                    {% if listing.phone %}
                    <a href="tel:{{ listing.phone }}"
                        class="block w-full bg-green-600 text-white text-center py-3 rounded-md hover:bg-green-700 transition-all"
                        style="box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                        Host Line: {{ listing.phone }}
                    </a>
                    {% endif %}

                    {% if listing.facebook_url %}
                    <a href="{{ listing.facebook_url }}" target="_blank" rel="noopener noreferrer"
                        class="block w-full bg-blue-600 text-white text-center py-3 rounded-md hover:bg-blue-700 transition-all"
                        style="box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                        Message on Facebook
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Booking Modal -->
<div id="bookingModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl max-w-md w-full max-h-[90vh] overflow-y-auto"
        style="box-shadow: 0 20px 50px rgba(0,0,0,0.3);">

        <!-- Step 1: Booking Form -->
        <div id="step1" class="p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-900">Đặt phòng trực tiếp</h3>
                <button onclick="closeBookingModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <form id="bookingForm" onsubmit="goToStep2(event)" class="space-y-4">
                <div>
                    <label for="fullname" class="block text-sm font-medium text-gray-700 mb-2">Họ và tên *</label>
                    <input type="text" id="fullname" name="fullname" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent">
                </div>

                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                    <input type="email" id="email" name="email" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent">
                </div>

                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">Số điện thoại *</label>
                    <input type="tel" id="phone" name="phone" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent">
                </div>

                <div>
                    <label for="guests" class="block text-sm font-medium text-gray-700 mb-2">Số khách *</label>
                    <select id="guests" name="guests" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent">
                        <option value="">Chọn số khách</option>
                        <option value="1">1 khách</option>
                        <option value="2">2 khách</option>
                        <option value="3">3 khách</option>
                        <option value="4">4 khách</option>
                        <option value="5">5 khách</option>
                        <option value="6">6+ khách</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="checkin" class="block text-sm font-medium text-gray-700 mb-2">Ngày nhận phòng
                            *</label>
                        <input type="date" id="checkin" name="checkin" required onchange="calculateNights()"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent">
                    </div>
                    <div>
                        <label for="checkout" class="block text-sm font-medium text-gray-700 mb-2">Ngày trả phòng
                            *</label>
                        <input type="date" id="checkout" name="checkout" required onchange="calculateNights()"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent">
                    </div>
                </div>

                <div id="nightsDisplay" class="hidden bg-gray-50 p-3 rounded-md">
                    <p class="text-sm text-gray-600">
                        <span id="nightsText"></span>
                        <span class="float-right font-semibold" id="totalPrice"></span>
                    </p>
                </div>

                <div>
                    <label for="message" class="block text-sm font-medium text-gray-700 mb-2">Tin nhắn (tùy
                        chọn)</label>
                    <textarea id="message" name="message" rows="3" placeholder="Ghi chú đặc biệt hoặc yêu cầu..."
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent"></textarea>
                </div>

                <button type="submit"
                    class="w-full bg-black text-white py-3 rounded-md hover:bg-gray-800 transition-all font-semibold">
                    Xác nhận đặt phòng
                </button>
            </form>
        </div>

        <!-- Step 2: Confirmation -->
        <div id="step2" class="p-6 hidden">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-900">Xác nhận thông tin</h3>
                <button onclick="closeBookingModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div id="bookingSummary" class="space-y-4 mb-6">
                <!-- Will be populated with booking details -->
            </div>

            <div class="flex space-x-3">
                <button onclick="goBackToStep1()"
                    class="flex-1 bg-gray-500 text-white py-3 rounded-md hover:bg-gray-600 transition-all font-semibold">
                    Trở về
                </button>
                <button onclick="confirmBooking()"
                    class="flex-1 bg-black text-white py-3 rounded-md hover:bg-gray-800 transition-all font-semibold">
                    Xác nhận đặt phòng
                </button>
            </div>
        </div>

        <!-- Step 3: QR Code Payment -->
        <div id="step3" class="p-6 hidden">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-900">Thanh toán</h3>
                <button onclick="closeBookingModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div class="text-center mb-6">
                <p class="text-gray-600 mb-4">Quét mã QR để thanh toán</p>
                <div id="qrContainer" class="flex justify-center mb-4">
                    <!-- QR Code will be inserted here -->
                </div>
                <p class="text-sm text-gray-500">Số tiền: <span id="paymentAmount" class="font-semibold"></span></p>
            </div>

            <button onclick="confirmPayment()"
                class="w-full bg-green-600 text-white py-3 rounded-md hover:bg-green-700 transition-all font-semibold">
                Xác nhận thanh toán
            </button>
        </div>

        <!-- Step 4: Success -->
        <div id="step4" class="p-6 hidden">
            <div class="text-center">
                <div class="mb-4">
                    <svg class="w-16 h-16 text-green-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-4">Đặt phòng thành công!</h3>
                <h3 class="text-xl font-bold text-gray-900 mb-4">Host Line: {{ listing.phone }}</h3>
                <h3 class="text-xl font-bold text-gray-900 mb-4">Email:contact@nguyenvietanh.com</h3>
                <p class="text-gray-600 mb-6">
                    Chúng tôi đã nhận được thông tin đặt phòng của bạn, nhân viên sẽ liên hệ bạn trong thời gian sớm
                    nhất.
                </p>
                <button onclick="closeBookingModal()"
                    class="w-full bg-black text-white py-3 rounded-md hover:bg-gray-800 transition-all font-semibold">
                    Đóng
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentBookingData = {};

    function openBookingModal() {
        document.getElementById('bookingModal').classList.remove('hidden');
        document.getElementById('bookingModal').classList.add('flex');
        document.body.style.overflow = 'hidden';

        // Set minimum date to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('checkin').min = today;
        document.getElementById('checkout').min = today;

        // Reset to step 1
        showStep(1);
    }

    function closeBookingModal() {
        document.getElementById('bookingModal').classList.add('hidden');
        document.getElementById('bookingModal').classList.remove('flex');
        document.body.style.overflow = 'auto';

        // Reset form
        document.getElementById('bookingForm').reset();
        document.getElementById('nightsDisplay').classList.add('hidden');
        currentBookingData = {};
    }

    function showStep(stepNumber) {
        // Hide all steps
        for (let i = 1; i <= 4; i++) {
            document.getElementById(`step${i}`).classList.add('hidden');
        }
        // Show current step
        document.getElementById(`step${stepNumber}`).classList.remove('hidden');
    }

    function calculateNights() {
        const checkin = new Date(document.getElementById('checkin').value);
        const checkout = new Date(document.getElementById('checkout').value);

        if (checkin && checkout && checkout > checkin) {
            const timeDiff = checkout.getTime() - checkin.getTime();
            const nights = Math.ceil(timeDiff / (1000 * 3600 * 24));

            document.getElementById('nightsText').textContent = `${nights} ngày ${nights - 1} đêm`;

            const pricePerNight = parseFloat("{{ listing.price|default:'0' }}");
            const totalPrice = pricePerNight * nights;
            document.getElementById('totalPrice').textContent = totalPrice.toLocaleString('vi-VN') + ' VND';

            document.getElementById('nightsDisplay').classList.remove('hidden');

            // Update checkout minimum date
            const nextDay = new Date(checkin);
            nextDay.setDate(nextDay.getDate() + 1);
            document.getElementById('checkout').min = nextDay.toISOString().split('T')[0];
        } else {
            document.getElementById('nightsDisplay').classList.add('hidden');
        }
    }

    function goToStep2(event) {
        event.preventDefault();

        const formData = new FormData(event.target);
        currentBookingData = Object.fromEntries(formData.entries());

        // Map field names to match backend expectations
        currentBookingData.checkin_date = currentBookingData.checkin;
        currentBookingData.checkout_date = currentBookingData.checkout;

        // Calculate nights and total
        const checkin = new Date(currentBookingData.checkin);
        const checkout = new Date(currentBookingData.checkout);
        const nights = Math.ceil((checkout.getTime() - checkin.getTime()) / (1000 * 3600 * 24));
        const pricePerNight = parseFloat("{{ listing.price|default:'0' }}");
        const total = pricePerNight * nights;

        currentBookingData.nights = nights;
        currentBookingData.total_price = total;
        currentBookingData.listing_id = parseInt("{{ listing.id|default:'0' }}");



        // Populate summary
        const summary = document.getElementById('bookingSummary');
        summary.innerHTML = `
        <div class="bg-gray-50 p-4 rounded-lg">
            <h4 class="font-semibold mb-3">Thông tin đặt phòng</h4>
            <div class="space-y-2 text-sm">
                <p><span class="font-medium">Khách sạn:</span> {{ listing.title }}</p>
                <p><span class="font-medium">Khách hàng:</span> ${currentBookingData.fullname}</p>
                <p><span class="font-medium">Email:</span> ${currentBookingData.email}</p>
                <p><span class="font-medium">Điện thoại:</span> ${currentBookingData.phone}</p>
                <p><span class="font-medium">Số khách:</span> ${currentBookingData.guests}</p>
                <p><span class="font-medium">Nhận phòng:</span> ${currentBookingData.checkin}</p>
                <p><span class="font-medium">Trả phòng:</span> ${currentBookingData.checkout}</p>
                <p><span class="font-medium">Thời gian:</span> ${nights} ngày ${nights - 1} đêm</p>
                <p><span class="font-medium">Tổng tiền:</span> ${total.toLocaleString('vi-VN')} VND</p>
                ${currentBookingData.message ? `<p><span class="font-medium">Tin nhắn:</span> ${currentBookingData.message}</p>` : ''}
            </div>
        </div>
    `;

        showStep(2);
    }

    function goBackToStep1() {
        showStep(1);
    }

    async function confirmBooking() {
        try {
            const response = await fetch('{% url "core:create_booking" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(currentBookingData)
            });

            const result = await response.json();

            if (result.success) {
                currentBookingData.booking_id = result.booking_id;
                await generateQRCode();
                showStep(3);
            } else {
                alert('Có lỗi xảy ra: ' + result.error);
            }
        } catch (error) {
            alert('Có lỗi xảy ra khi đặt phòng: ' + error.message);
        }
    }

    async function generateQRCode() {
        try {
            // Show loading message briefly for better UX
            document.getElementById('qrContainer').innerHTML = `
                <div class="flex items-center justify-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-black"></div>
                    <span class="ml-2">Đang hiển thị mã QR...</span>
                </div>
            `;

            // Simulate short loading time for better UX
            await new Promise(resolve => setTimeout(resolve, 500));

            // Display the local QR code image
            document.getElementById('qrContainer').innerHTML = `
                <img src="{% static 'core/images/qrcode/qrcode.svg' %}" 
                     alt="QR Code Payment" 
                     class="max-w-full h-auto border rounded-lg shadow-md"
                     style="max-width: 250px;">
            `;

            // Display the payment amount
            document.getElementById('paymentAmount').textContent =
                currentBookingData.total_price.toLocaleString('vi-VN') + ' VND';

        } catch (error) {
            console.error('QR Display Error:', error);
            document.getElementById('qrContainer').innerHTML = `
                <div class="text-center p-4">
                    <p class="text-red-500 mb-2">Không thể hiển thị mã QR</p>
                    <p class="text-sm text-gray-500">Vui lòng liên hệ trực tiếp</p>
                </div>
            `;
        }
    }

    function confirmPayment() {
        showStep(4);
    }

    // Close modal when clicking outside
    document.getElementById('bookingModal').addEventListener('click', function (e) {
        if (e.target === this) {
            closeBookingModal();
        }
    });
</script>
{% endblock %}